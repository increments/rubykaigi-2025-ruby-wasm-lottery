<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>シンプルなくじ引き</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      text-align: center;
    }
    .lottery-box {
      border: 2px solid #ccc;
      padding: 20px;
      margin-bottom: 20px;
      min-height: 100px;
    }
    button {
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div id="app"></div>
  <script src="https://getty104.github.io/ruby-wasm-vdom/index.js"></script>
  <script>
    console.log("JavaScriptが読み込まれました");
    // デバッグ用のエラーハンドラー
    window.onerror = function(message, source, lineno, colno, error) {
      console.error("JavaScriptエラー:", message, "行:", lineno, "列:", colno);
      document.body.innerHTML += "<div style='color:red'>エラー: " + message + "</div>";
      return true;
    };
  </script>
  <script type="text/ruby">
    puts "Rubyスクリプトが実行されました"

    # シンプルな状態
    state = {
      prizes: ["特賞", "1等", "2等", "3等", "4等"],
      result: nil,
      drawing: false
    }

    # アクション
    actions = {
      draw: ->(state, _value) {
        puts "drawアクションが呼ばれました"
        return if state[:drawing]

        state[:drawing] = true
        state[:result] = nil

        # 抽選処理（JavaScriptで実装）
        `
        console.log("抽選処理を開始します");
        setTimeout(() => {
          console.log("抽選処理を完了します");
          const randomIndex = Math.floor(Math.random() * state.prizes.length);
          actions.set_result.call(state, state.prizes[randomIndex]);
        }, 1000);
        `
      },

      set_result: ->(state, result) {
        puts "set_resultアクションが呼ばれました: #{result}"
        state[:result] = result
        state[:drawing] = false
      }
    }

    # ビュー（通常のh関数を使用）
    view = ->(state, actions) {
      puts "ビュー関数が呼ばれました"
      h(:div, {}, [
        h(:h1, {}, ["くじ引きアプリ"]),
        h(:div, { class: "lottery-box" }, [
          state[:drawing] ?
            h(:p, {}, ["抽選中..."]) :
            state[:result] ?
              h(:h2, {}, ["結果: #{state[:result]}"]) :
              h(:p, {}, ["ボタンを押してくじを引いてください"])
        ]),
        h(:button, {
          onclick: ->(e) { actions[:draw].call(state, nil) },
          disabled: state[:drawing]
        }, [
          state[:drawing] ? "抽選中..." : "くじを引く"
        ])
      ])
    }

    # アプリケーション初期化
    puts "アプリの初期化を開始します"
    RubyWasmVdom::App.new(
      el: "#app",
      state: state,
      view: view,
      actions: actions
    )
    puts "アプリの初期化が完了しました"
  </script>
</body>
</html>
