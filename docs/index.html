<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¤¢ã®ãã˜å¼•ãã‚¢ãƒ—ãƒª</title>
  <style>
    /* ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« */
    body {
      font-family: 'Rounded Mplus 1c', 'Hiragino Kaku Gothic ProN', sans-serif;
      background: #f6f6f6;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0;
      padding: 20px;
    }

    .lottery-container {
      background-color: white;
      border-radius: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 30px;
      text-align: center;
      max-width: 500px;
      width: 100%;
      overflow: hidden;
      position: relative;
    }

    h1 {
      color: #2e8b57;
      margin-bottom: 30px;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
      position: relative;
    }

    h1::after {
      content: '';
      display: block;
      width: 60px;
      height: 4px;
      background: linear-gradient(90deg, #55c500, #3fa54a);
      margin: 10px auto 0;
      border-radius: 2px;
    }

    /* ãã˜ç®±ã‚¹ã‚¿ã‚¤ãƒ« */
    .lottery-box {
      background-color: #fafafa;
      border-radius: 15px;
      border: 2px dashed #55c500;
      height: 200px;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 30px;
      overflow: hidden;
      position: relative;
      transition: all 0.3s ease;
    }

    /* æŠ½é¸ãƒœã‚¿ãƒ³ */
    button {
      background: linear-gradient(45deg, #55c500 0%, #3fa54a 100%);
      border: none;
      border-radius: 50px;
      color: white;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      padding: 15px 30px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(85, 197, 0, 0.3);
    }

    button:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 7px 20px rgba(85, 197, 0, 0.4);
    }

    button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    /* çµæœè¡¨ç¤º */
    .result {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      animation: fadeIn 0.5s ease-out;
    }

    .prize-icon {
      font-size: 40px;
      margin-bottom: 10px;
      color: white;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
    }

    .prize-name {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 5px;
      color: white;
    }

    .prize-description {
      font-size: 16px;
      color: white;
    }

    .instruction {
      font-size: 18px;
      color: #666;
      padding: 20px;
    }

    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes sparkle {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; text-shadow: 0 0 10px white, 0 0 20px white; }
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }

    @keyframes rotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    /* æŠ½é¸ä¸­ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .drawing-animation {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }

    .drawing-animation::before {
      content: '';
      position: absolute;
      width: 150%;
      height: 150%;
      background: linear-gradient(45deg, #55c500, #3fa54a, #e8f5e9, #a5d6a7);
      background-size: 400% 400%;
      animation: gradientShift 3s ease infinite;
      border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; transform: rotate(0deg); }
      50% { background-position: 100% 50%; transform: rotate(180deg); }
      100% { background-position: 0% 50%; transform: rotate(360deg); }
    }

    .drawing-text {
      position: relative;
      color: white;
      font-size: 24px;
      font-weight: bold;
      text-shadow: 0 2px 5px rgba(0,0,0,0.2);
      animation: pulse 1s infinite;
    }

    /* ç´™å¹é›ªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: var(--color);
      top: -10px;
      z-index: 10;
      animation: confetti-fall var(--fall-duration) linear forwards;
    }

    @keyframes confetti-fall {
      to {
        transform: translateY(calc(100vh + 10px)) rotate(360deg);
      }
    }

    #confetti-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 100;
    }

    #debug {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      text-align: left;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
      display: none;
    }

    .error {
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="app"></div>
  <div id="confetti-container"></div>
  <div id="debug"></div>

  <script src="https://getty104.github.io/ruby-wasm-vdom/index.js"></script>
  <script>
    console.log("JavaScriptãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ");

    // ç´™å¹é›ªã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”¨ã®é–¢æ•°
    function createConfetti() {
      const container = document.getElementById('confetti-container');
      if (!container) return;

      const colors = ['#55c500', '#3fa54a', '#a5d6a7', '#e8f5e9', '#c8e6c9', '#81c784'];
      const confettiCount = 100;

      for (let i = 0; i < confettiCount; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.setProperty('--color', colors[Math.floor(Math.random() * colors.length)]);
        confetti.style.setProperty('--fall-duration', (Math.random() * 3 + 2) + 's');
        confetti.style.left = Math.random() * 100 + 'vw';
        container.appendChild(confetti);

        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œã«è¦ç´ ã‚’å‰Šé™¤ï¼ˆè¦ªè¦ç´ ã®ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ ï¼‰
        confetti.addEventListener('animationend', () => {
          try {
            if (confetti.parentNode) {
              confetti.parentNode.removeChild(confetti);
            } else {
              confetti.remove();
            }
          } catch (e) {
            console.error("ç´™å¹é›ªã®å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", e);
          }
        });
      }
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«é–¢æ•°ã‚’å…¬é–‹
    window.createConfetti = createConfetti;
  </script>
  <script type="text/ruby">
    puts "Rubyã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸ"

    # ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹
    window = JS.global
    document = JS.global[:document]
    console = JS.global[:console]

    # ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°é–¢æ•°
    def log(message)
      JS.global[:console].log(message)
    end

    log("Ruby JS APIã‚’ä½¿ç”¨ã—ã¦åˆæœŸåŒ–ã—ã¾ã™")

    # è³å“ãƒ‡ãƒ¼ã‚¿ã‚’Data.defineã§å®šç¾©
    Prize = Data.define(:name, :description, :probability, :color, :icon, :animation) do
      # è¡¨ç¤ºç”¨ã®ãƒ¡ã‚½ãƒƒãƒ‰
      def to_h
        {
          name: name,
          description: description,
          color: color,
          icon: icon,
          animation: animation
        }
      end
    end

    # è³å“ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹
    class PrizeCollection
      def initialize
        @prizes = [
          Prize.new(
            name: "ç‰¹ç­‰è³",
            description: "è±ªè¯æ—…è¡Œåˆ¸",
            probability: 0.05,
            color: "linear-gradient(135deg, #55c500, #2d8500)",
            icon: "ğŸ†",
            animation: "sparkle"
          ),
          Prize.new(
            name: "1ç­‰",
            description: "ã‚®ãƒ•ãƒˆã‚«ãƒ¼ãƒ‰5000å††åˆ†",
            probability: 0.1,
            color: "linear-gradient(135deg, #67c73a, #3fa54a)",
            icon: "ğŸ",
            animation: "bounce"
          ),
          Prize.new(
            name: "2ç­‰",
            description: "é¸ã¹ã‚‹ã‚°ãƒ«ãƒ¡ã‚®ãƒ•ãƒˆ",
            probability: 0.15,
            color: "linear-gradient(135deg, #81c784, #4caf50)",
            icon: "ğŸ°",
            animation: "rotate"
          ),
          Prize.new(
            name: "3ç­‰",
            description: "ã‚ªãƒªã‚¸ãƒŠãƒ«ã‚°ãƒƒã‚º",
            probability: 0.3,
            color: "linear-gradient(135deg, #a5d6a7, #66bb6a)",
            icon: "ğŸ¨",
            animation: "pulse"
          ),
          Prize.new(
            name: "4ç­‰",
            description: "ãŠè“å­è©°ã‚åˆã‚ã›",
            probability: 0.4,
            color: "linear-gradient(135deg, #c8e6c9, #81c784)",
            icon: "ğŸ¬",
            animation: "shake"
          )
        ]
      end

      # ç¢ºç‡ã«åŸºã¥ã„ã¦è³å“ã‚’é¸æŠã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
      def draw(random_value)
        cumulative_probability = 0

        @prizes.each do |prize|
          cumulative_probability += prize.probability
          return prize if random_value <= cumulative_probability
        end

        # ä¸‡ãŒä¸€ç¢ºç‡ã®åˆè¨ˆãŒ1ã«æº€ãŸãªã„å ´åˆã¯æœ€å¾Œã®è³å“ã‚’è¿”ã™
        @prizes.last
      end

      # å…¨è³å“ã‚’å–å¾—
      def all
        @prizes
      end
    end

    # ãã˜ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
    prize_collection = PrizeCollection.new

    # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ï¼ˆè³å“ãƒ‡ãƒ¼ã‚¿ã¯é™¤å¤–ï¼‰
    state = {
      result: nil,
      drawing: false
    }

    # ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®šç¾©
    actions = {
      draw_lottery: ->(state, options) {
        begin
          actions = options[:actions]
          puts "æŠ½é¸ã‚’é–‹å§‹ã—ã¾ã™"
          return if state[:drawing]

          state[:drawing] = true
          state[:result] = nil

          # æŠ½é¸ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ã‚¿ã‚¤ãƒãƒ¼å‡¦ç†ï¼ˆJS APIã‚’ä½¿ç”¨ï¼‰
          log("æŠ½é¸å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™")

          # JS.globalã‹ã‚‰setTimeoutã‚’å‘¼ã³å‡ºã™
          window.setTimeout(
            ->{
              begin
                # ç¢ºç‡ã«åŸºã¥ã„ãŸæŠ½é¸ãƒ­ã‚¸ãƒƒã‚¯
                rand = window[:Math].random.to_f
                selected_prize = prize_collection.draw(rand)

                log("æŠ½é¸çµæœ: #{selected_prize.name}")
                # çµæœã‚’stateã«åæ˜ ã•ã›ã‚‹
                actions[:set_result].call(state, { prize: selected_prize, actions: actions })
              rescue => e
                console.error("æŠ½é¸å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", e.to_s)
                # ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯æŠ½é¸çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                state[:drawing] = false
              end
            },
            3000
          )
        rescue => e
          puts "Rubyã‚³ãƒ¼ãƒ‰å†…ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: #{e.message}"
          puts e.backtrace.join("\n")
          state[:drawing] = false
        end
      },

      set_result: ->(state, options) {
        begin
          prize = options[:prize]
          actions = options[:actions]

          puts "æŠ½é¸çµæœã‚’è¨­å®šã—ã¾ã™: #{prize.name}"
          state[:result] = prize.to_h
          state[:drawing] = false

          # ç´™å¹é›ªã‚’è¡¨ç¤ºï¼ˆJS APIã‚’ä½¿ç”¨ï¼‰
          log("ç´™å¹é›ªã‚’è¡¨ç¤ºã—ã¾ã™")

          begin
            # ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°createConfettiã‚’å‘¼ã³å‡ºã™
            window.createConfetti
          rescue => e
            # ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ã¯æ¯å›JS.globalã‹ã‚‰å–å¾—
            console = JS.global[:console]
            console.error("ç´™å¹é›ªç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", e.to_s)
          end
        rescue => e
          puts "æŠ½é¸çµæœè¨­å®šä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: #{e.message}"
          puts e.backtrace.join("\n")
        end
      }
    }

    # ãƒ“ãƒ¥ãƒ¼å®Ÿè£…ï¼ˆhé–¢æ•°ã‚’ä½¿ç”¨ã—ãŸå®Ÿè£…ï¼‰
    view = ->(state, actions) {
      puts "ãƒ“ãƒ¥ãƒ¼é–¢æ•°ãŒå‘¼ã°ã‚Œã¾ã—ãŸ"
      puts "ç¾åœ¨ã®çŠ¶æ…‹: #{state.inspect}"

      # ãã˜ç®±ã®å†…å®¹
      content = if state[:drawing]
        h(:div, { class: "drawing-animation" }, [
          h(:span, { class: "drawing-text" }, ["æŠ½é¸ä¸­..."])
        ])
      elsif state[:result]
        # çµæœè¡¨ç¤ºï¼ˆnullãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
        color = state[:result][:color] || "linear-gradient(135deg, #E0E0E0, #C0C0C0)"
        animation = state[:result][:animation] || "none"
        icon = state[:result][:icon] || "ğŸ"
        name = state[:result][:name] || "çµæœ"
        description = state[:result][:description] || ""

        h(:div, { class: "result", style: "background: #{color}" }, [
          h(:div, { class: "prize-icon", style: "animation: #{animation} 2s infinite" }, [icon]),
          h(:div, { class: "prize-name" }, [name]),
          h(:div, { class: "prize-description" }, [description])
        ])
      else
        h(:div, { class: "instruction" }, [
          h(:span, {}, ["ğŸ‘‡ ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã˜ã‚’å¼•ã„ã¦ãã ã•ã„ ğŸ‘‡"])
        ])
      end

      # ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
      button_text = state[:drawing] ? "æŠ½é¸ä¸­..." : "ãã˜ã‚’å¼•ãï¼"

      # ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ
      h(:div, { class: "lottery-container" }, [
        h(:h1, {}, ["âœ¨ å¤¢ã®ãã˜å¼•ã âœ¨"]),
        h(:div, { class: "lottery-box" }, [content]),
        h(:button, {
          onclick: ->(e) { actions[:draw_lottery].call(state, { actions: actions }) },
          disabled: state[:drawing] ? true : nil
        }.compact, [button_text])
      ])
    }

    # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
    puts "ã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–ã‚’é–‹å§‹ã—ã¾ã™"
    RubyWasmVdom::App.new(
      el: "#app",
      state: state,
      view: view,
      actions: actions
    )
    puts "ã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸ"
  </script>
</body>
</html>
