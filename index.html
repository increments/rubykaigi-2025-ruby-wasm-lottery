<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>夢のくじ引きアプリ</title>
  <style>
    /* ベーススタイル */
    body {
      font-family: 'Rounded Mplus 1c', 'Hiragino Kaku Gothic ProN', sans-serif;
      background: linear-gradient(120deg, #f5f7fa, #c3cfe2);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0;
      padding: 20px;
    }

    .lottery-container {
      background-color: white;
      border-radius: 20px;
      box-shadow: 0 15px 30px rgba(0,0,0,0.15);
      padding: 30px;
      text-align: center;
      max-width: 500px;
      width: 100%;
      overflow: hidden;
      position: relative;
    }

    h1 {
      color: #5d4037;
      margin-bottom: 30px;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
      position: relative;
    }

    h1::after {
      content: '';
      display: block;
      width: 60px;
      height: 4px;
      background: linear-gradient(90deg, #ff9a9e, #fad0c4);
      margin: 10px auto 0;
      border-radius: 2px;
    }

    /* くじ箱スタイル */
    .lottery-box {
      background-color: #fafafa;
      border-radius: 15px;
      border: 2px dashed #d1c4e9;
      height: 200px;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 30px;
      overflow: hidden;
      position: relative;
      transition: all 0.3s ease;
    }

    /* 抽選ボタン */
    button {
      background: linear-gradient(45deg, #ff9a9e 0%, #fad0c4 100%);
      border: none;
      border-radius: 50px;
      color: white;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      padding: 15px 30px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(255, 154, 158, 0.3);
    }

    button:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 7px 20px rgba(255, 154, 158, 0.4);
    }

    button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    /* 結果表示 */
    .result {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      animation: fadeIn 0.5s ease-out;
    }

    .prize-icon {
      font-size: 40px;
      margin-bottom: 10px;
    }

    .prize-name {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .prize-description {
      font-size: 16px;
    }

    .instruction {
      font-size: 18px;
      color: #666;
      padding: 20px;
    }

    /* アニメーション */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes sparkle {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; text-shadow: 0 0 10px white, 0 0 20px white; }
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }

    @keyframes rotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    /* 抽選中アニメーション */
    .drawing-animation {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }

    .drawing-animation::before {
      content: '';
      position: absolute;
      width: 150%;
      height: 150%;
      background: linear-gradient(45deg, #ff9a9e, #fad0c4, #ffecd2, #fcb69f);
      background-size: 400% 400%;
      animation: gradientShift 3s ease infinite;
      border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; transform: rotate(0deg); }
      50% { background-position: 100% 50%; transform: rotate(180deg); }
      100% { background-position: 0% 50%; transform: rotate(360deg); }
    }

    .drawing-text {
      position: relative;
      color: white;
      font-size: 24px;
      font-weight: bold;
      text-shadow: 0 2px 5px rgba(0,0,0,0.2);
      animation: pulse 1s infinite;
    }

    /* 紙吹雪アニメーション */
    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: var(--color);
      top: -10px;
      z-index: 10;
      animation: confetti-fall var(--fall-duration) linear forwards;
    }

    @keyframes confetti-fall {
      to {
        transform: translateY(calc(100vh + 10px)) rotate(360deg);
      }
    }

    #confetti-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 100;
    }

    #debug {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      text-align: left;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
      display: none;
    }

    .error {
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="app"></div>
  <div id="debug"></div>

  <script src="https://getty104.github.io/ruby-wasm-vdom/index.js"></script>
  <script>
    console.log("JavaScriptが読み込まれました");

    // 紙吹雪エフェクト用の関数
    function createConfetti() {
      const container = document.getElementById('confetti-container');
      if (!container) return;

      const colors = ['#ff9a9e', '#fad0c4', '#ffecd2', '#fcb69f', '#a18cd1', '#fbc2eb'];
      const confettiCount = 100;

      for (let i = 0; i < confettiCount; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.setProperty('--color', colors[Math.floor(Math.random() * colors.length)]);
        confetti.style.setProperty('--fall-duration', (Math.random() * 3 + 2) + 's');
        confetti.style.left = Math.random() * 100 + 'vw';
        container.appendChild(confetti);

        // アニメーション終了後に要素を削除
        confetti.addEventListener('animationend', () => {
          confetti.remove();
        });
      }
    }

    // グローバルに関数を公開
    window.createConfetti = createConfetti;
  </script>
  <script type="text/ruby">
    puts "Rubyスクリプトが実行されました"

    # グローバルオブジェクトへのアクセス
    window = JS.global
    document = JS.global[:document]
    console = JS.global[:console]

    # デバッグログ関数
    def log(message)
      JS.global[:console].log(message)
    end

    log("Ruby JS APIを使用して初期化します")

    # くじデータとアプリケーションの状態
    state = {
      prizes: [
        {
          name: "特等賞",
          description: "豪華旅行券",
          probability: 0.05,
          color: "linear-gradient(135deg, #FFD700, #FFA500)",
          icon: "🏆",
          animation: "sparkle"
        },
        {
          name: "1等",
          description: "ギフトカード5000円分",
          probability: 0.1,
          color: "linear-gradient(135deg, #E6E6FA, #C0C0C0)",
          icon: "🎁",
          animation: "bounce"
        },
        {
          name: "2等",
          description: "選べるグルメギフト",
          probability: 0.15,
          color: "linear-gradient(135deg, #CD853F, #CD7F32)",
          icon: "🍰",
          animation: "rotate"
        },
        {
          name: "3等",
          description: "オリジナルグッズ",
          probability: 0.3,
          color: "linear-gradient(135deg, #98FB98, #ADFF2F)",
          icon: "🎨",
          animation: "pulse"
        },
        {
          name: "4等",
          description: "お菓子詰め合わせ",
          probability: 0.4,
          color: "linear-gradient(135deg, #87CEFA, #1E90FF)",
          icon: "🍬",
          animation: "shake"
        }
      ],
      result: nil,
      drawing: false,
      animation_complete: false,
      confetti_active: false
    }

    # アクション定義
    actions = {
      draw_lottery: ->(state, options) {
        begin
          actions = options[:actions]
          puts "抽選を開始します"
          return if state[:drawing]

          state[:drawing] = true
          state[:animation_complete] = false
          state[:result] = nil

          # 抽選アニメーション用のタイマー処理（JS APIを使用）
          log("抽選処理を開始します")

          # JS.globalからsetTimeoutを呼び出す
          window.setTimeout(
            ->{
              begin
                # 確率に基づいた抽選ロジック
                rand = window[:Math].random.to_f
                cumulative_probability = 0
                selected_prize = nil

                state[:prizes].each do |prize|
                  cumulative_probability += prize[:probability]
                  if rand <= cumulative_probability
                    selected_prize = prize
                    break
                  end
                end

                log("抽選結果: #{selected_prize[:name]}")
                # 結果をstateに反映させる
                actions[:set_result].call(state, { prize: selected_prize, actions: actions })
              rescue => e
                console.error("抽選処理中にエラーが発生しました:", e.to_s)
                # エラーが発生した場合は抽選状態をリセット
                state[:drawing] = false
              end
            },
            3000
          )
        rescue => e
          puts "Rubyコード内でエラーが発生しました: #{e.message}"
          puts e.backtrace.join("\n")
          state[:drawing] = false
        end
      },

      set_result: ->(state, options) {
        begin
          prize = options[:prize]
          actions = options[:actions]

          puts "抽選結果を設定します: #{prize[:name]}"
          state[:result] = prize
          state[:drawing] = false
          state[:animation_complete] = true
          state[:confetti_active] = true

          # 紙吹雪を表示（JS APIを使用）
          log("紙吹雪を表示します")

          # confetti_activeの場合のみ紙吹雪を表示
          if state[:confetti_active]
            begin
              # グローバル関数createConfettiを呼び出す
              window.createConfetti

              # 一定時間後に紙吹雪をクリア
              window.setTimeout(
                ->{
                  begin
                    actions[:clear_confetti].call(state, { actions: actions })
                  rescue => e
                    # メソッド内では毎回JS.globalから取得
                    console = JS.global[:console]
                    console.error("紙吹雪クリア中にエラーが発生しました:", e.to_s)
                  end
                },
                5000
              )
            rescue => e
              # メソッド内では毎回JS.globalから取得
              console = JS.global[:console]
              console.error("紙吹雪生成中にエラーが発生しました:", e.to_s)
            end
          end
        rescue => e
          puts "抽選結果設定中にエラーが発生しました: #{e.message}"
          puts e.backtrace.join("\n")
        end
      },

      clear_confetti: ->(state, options) {
        begin
          actions = options[:actions]
          puts "紙吹雪をクリアします"
          state[:confetti_active] = false
        rescue => e
          puts "紙吹雪クリア中にRubyでエラーが発生しました: #{e.message}"
          puts e.backtrace.join("\n")
        end
      }
    }

    # ビュー実装（h関数を使用した実装）
    view = ->(state, actions) {
      puts "ビュー関数が呼ばれました"
      puts "現在の状態: #{state.inspect}"

      # くじ箱の内容
      content = if state[:drawing]
        h(:div, { class: "drawing-animation" }, [
          h(:span, { class: "drawing-text" }, ["抽選中..."])
        ])
      elsif state[:result]
        # 結果表示（nullチェック付き）
        color = state[:result][:color] || "linear-gradient(135deg, #E0E0E0, #C0C0C0)"
        animation = state[:result][:animation] || "none"
        icon = state[:result][:icon] || "🎁"
        name = state[:result][:name] || "結果"
        description = state[:result][:description] || ""

        h(:div, { class: "result", style: "background: #{color}" }, [
          h(:div, { class: "prize-icon", style: "animation: #{animation} 2s infinite" }, [icon]),
          h(:div, { class: "prize-name" }, [name]),
          h(:div, { class: "prize-description" }, [description])
        ])
      else
        h(:div, { class: "instruction" }, [
          h(:span, {}, ["👇 下のボタンを押してくじを引いてください 👇"])
        ])
      end

      # ボタンテキスト
      button_text = state[:drawing] ? "抽選中..." : "くじを引く！"

      # メインコンテナ
      h(:div, { class: "lottery-container" }, [
        h(:h1, {}, ["✨ 夢のくじ引き ✨"]),
        h(:div, { class: "lottery-box" }, [content]),
        h(:button, {
          onclick: ->(e) { actions[:draw_lottery].call(state, { actions: actions }) },
          disabled: state[:drawing] ? true : nil
        }.compact, [button_text]),
        state[:confetti_active] ? h(:div, { id: "confetti-container" }, []) : nil
      ])
    }

    # アプリケーション初期化
    puts "アプリの初期化を開始します"
    RubyWasmVdom::App.new(
      el: "#app",
      state: state,
      view: view,
      actions: actions
    )
    puts "アプリの初期化が完了しました"
  </script>
</body>
</html>
